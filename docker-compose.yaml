services:
  mailhog-keycloak:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - 1025:1025 # smtp server
      - 8025:8025 # web ui
    networks:
      - keycloak_network

  keycloak:
    image: quay.io/keycloak/keycloak:11.0.3
    container_name: keycloak
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: admin
      KEYCLOAK_IMPORT: '/tmp/realm-export.json'
      KEYCLOAK_LOGLEVEL: 'DEBUG'
      JAVA_OPTS: '-Dkeycloak.profile.feature.scripts=enabled -Dkeycloak.profile.feature.upload_scripts=enabled'
    ports:
      - 8080:8080
    volumes:
      - './keycloak/realms:/tmp'
      - './keycloak/extensions:/opt/jboss/keycloak/standalone/deployments'
    networks:
      - keycloak_network

  postgres:
    image: postgres:13.2
    restart: always
    container_name: postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - '5432:5432'
    networks:
      - db_network

  flyway:
    container_name: flyway
    environment:
      - FLYWAY_URL=jdbc:postgresql://postgres:5432/postgres
    image: flyway/flyway:7.8.1
    command: -connectRetries=60 migrate
    networks:
      - db_network
    volumes:
      - $PWD/src/main/resources/db/migration:/flyway/sql
      - $PWD/flyway.conf:/flyway/conf/flyway.conf
    depends_on:
      - postgres

networks:
  db_network:
  keycloak_network: